<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>To-Do List - EtherX (Improved)</title>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body {
      background: #0b0b0b; color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background .25s, color .25s;
      min-height: 100vh;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body.light { background: #fff; color: #111; }/* Layout */
header { display:flex; justify-content:space-between; align-items:center; padding:1rem; }
header .left { display:flex; gap:.5rem; align-items:center }
header button { font-size:1rem; background:transparent; border:1px solid currentColor; padding:.4rem .6rem; border-radius:6px; color:inherit; cursor:pointer }

.container { max-width:800px; margin:0 auto; padding:1rem; }
.input-row { display:flex; gap:.5rem; align-items:center; margin-bottom:1rem }
#newTask { flex:1; padding:.6rem .75rem; border-radius:8px; border:1px solid #444; background:transparent; color:inherit; font-size:1rem }
body.light #newTask { border-color:#ccc }
#addTask { padding:.55rem .9rem; border-radius:8px; border:none; background:#2b8bd8; color:#fff; cursor:pointer }

/* Controls */
.controls { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom: .75rem }
.controls .filter { padding:.4rem .6rem; border-radius:6px; border:1px solid currentColor; background:transparent; cursor:pointer }
.controls .active { background: rgba(255,255,255,0.06) }

/* Task List */
ul { list-style:none; margin-top:.5rem; display:block }
li { display:flex; justify-content:space-between; align-items:flex-start; gap:.75rem; padding:.7rem; border-radius:8px; border:1px solid rgba(255,255,255,0.06); margin-bottom:.5rem }
body.light li { border-color: rgba(0,0,0,0.06) }
.task-left { display:flex; gap:.75rem; align-items:flex-start; flex:1 }
.check { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:6px; border:1px solid currentColor; cursor:pointer }
.task-body { display:flex; flex-direction:column; gap:.25rem; max-width:100% }
.task-text { font-size:1rem; word-break:break-word }
.task-text.done{ text-decoration:line-through; opacity:.6 }
.task-meta { font-size:.8rem; opacity:.6 }
.task-actions { display:flex; gap:.5rem; align-items:center }
.task-actions button { background:transparent; border:none; color:inherit; cursor:pointer; padding:.25rem }

/* Small utilities */
.muted { opacity:.7; font-size:.9rem }
.toolbar { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom: .5rem }

/* Confetti Canvas */
.confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events:none; z-index:9999 }

/* Responsive */
@media (max-width:560px){ #newTask { font-size:.95rem } }

  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="homeBtn">‚Üê Home</button>
      <div class="muted">EtherX ‚Ä¢ To‚ÄëDo</div>
    </div>
    <div>
      <button id="themeBtn">Toggle Theme</button>
    </div>
  </header>  <div class="container">
    <div class="toolbar">
      <div class="controls" role="tablist" aria-label="filters">
        <button class="filter active" data-filter="all">All</button>
        <button class="filter" data-filter="active">Active</button>
        <button class="filter" data-filter="done">Completed</button>
      </div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button id="clearCompleted">Clear Completed</button>
        <button id="exportBtn">Export</button>
        <button id="importBtn">Import</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
      </div>
    </div><div class="input-row">
  <input id="newTask" placeholder="Add a task... (press Enter to add)" autocomplete="off">
  <button id="addTask">Add</button>
</div>

<ul id="tasks" aria-live="polite"></ul>

<div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center">
  <div class="muted" id="stats"></div>
  <div class="muted">Limit: <span id="taskLimit">2000</span> tasks</div>
</div>

  </div><canvas class="confetti" id="confettiCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>  <script>
    // ------------------ Data Model ------------------
    // Each task: { id: string, text: string, done: boolean, timestamp: number }
    const MAX_TASKS = 2000;

    function uuid(){ return 't-'+Math.random().toString(36).slice(2,10); }

    let tasks = [];
    try{
      const raw = localStorage.getItem('todoTasks');
      if(raw) tasks = JSON.parse(raw);
      if(!Array.isArray(tasks)) tasks = [];
    }catch(e){ tasks = []; }

    // Theme
    const savedTheme = localStorage.getItem('todoTheme');
    if(savedTheme === 'light') document.body.classList.add('light');

    // Save & persist
    function save(){
      try{ localStorage.setItem('todoTasks', JSON.stringify(tasks)); }catch(e){ console.error('Save failed',e); }
    }

    // ------------------ Utilities ------------------
    function formatTimestamp(ts){
      try{ return new Date(ts).toLocaleString(); }catch(e){ return '' }
    }

    // Safe element builder for a task item (prevents XSS by never using innerHTML with user text)
    function buildTaskNode(task, index){
      const li = document.createElement('li');
      li.dataset.id = task.id;

      const left = document.createElement('div'); left.className = 'task-left';
      const check = document.createElement('div'); check.className='check'; check.setAttribute('role','checkbox'); check.setAttribute('aria-checked', task.done);
      check.tabIndex = 0; check.innerText = task.done ? '‚úî' : '';
      left.appendChild(check);

      const body = document.createElement('div'); body.className='task-body';
      const text = document.createElement('div'); text.className='task-text';
      if(task.done) text.classList.add('done');
      text.textContent = task.text; // <-- SAFE: textContent avoids XSS

      const meta = document.createElement('div'); meta.className='task-meta'; meta.textContent = formatTimestamp(task.timestamp);
      body.appendChild(text); body.appendChild(meta);
      left.appendChild(body);

      const actions = document.createElement('div'); actions.className='task-actions';
      const editBtn = document.createElement('button'); editBtn.title='Edit'; editBtn.innerText='‚úèÔ∏è';
      const delBtn = document.createElement('button'); delBtn.title='Delete'; delBtn.innerText='üóëÔ∏è';
      actions.appendChild(editBtn); actions.appendChild(delBtn);

      li.appendChild(left); li.appendChild(actions);

      // Event listeners
      check.addEventListener('click', ()=> toggleDone(task.id));
      check.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleDone(task.id); } });
      editBtn.addEventListener('click', ()=> editTaskInline(task.id, text));
      delBtn.addEventListener('click', ()=> deleteTask(task.id));

      return li;
    }

    // ------------------ CRUD Operations ------------------
    function addTask(text){
      if(!text || !text.trim()) return;
      if(tasks.length >= MAX_TASKS) return alert('Task limit reached');
      const t = { id: uuid(), text: text.trim(), done:false, timestamp: Date.now() };
      tasks.unshift(t); // newest first
      save(); render();
    }

    function toggleDone(id){
      const i = tasks.findIndex(t=>t.id===id); if(i<0) return;
      if(tasks[i].done) return; // do not un-complete by design (one-time complete). Remove this check to allow toggle.
      tasks[i].done = true; tasks[i].completedAt = Date.now();
      save(); render(); fireConfetti();
    }

    function deleteTask(id){
      const i = tasks.findIndex(t=>t.id===id); if(i<0) return;
      tasks.splice(i,1); save(); render();
    }

    function editTaskInline(id, textNode){
      const i = tasks.findIndex(t=>t.id===id); if(i<0) return;
      // replace textNode with an input
      const input = document.createElement('input'); input.type='text'; input.value = tasks[i].text; input.style.width='100%';
      textNode.replaceWith(input); input.focus();
      function finish(){
        const v = input.value.trim();
        if(v) tasks[i].text = v;
        input.replaceWith(textNode); textNode.textContent = tasks[i].text; save(); render();
      }
      input.addEventListener('blur', finish);
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') finish(); if(e.key==='Escape'){ input.replaceWith(textNode); } });
    }

    function clearCompleted(){ if(!confirm('Clear all completed tasks?')) return; tasks = tasks.filter(t=>!t.done); save(); render(); }

    // ------------------ Filters & Search ------------------
    let activeFilter = 'all';
    function setFilter(f){ activeFilter = f; Array.from(document.querySelectorAll('.filter')).forEach(b=> b.classList.toggle('active', b.dataset.filter===f)); render(); }

    // ------------------ Render ------------------
    const tasksUL = document.getElementById('tasks');
    function render(){
      // build visible list based on filter
      tasksUL.innerHTML = '';
      const frag = document.createDocumentFragment();
      let visible = tasks.filter(t=>{
        if(activeFilter==='all') return true;
        if(activeFilter==='active') return !t.done;
        return t.done;
      });
      visible.forEach((t, idx)=> {
        const node = buildTaskNode(t, idx);
        frag.appendChild(node);
      });
      tasksUL.appendChild(frag);
      // stats
      const total = tasks.length; const done = tasks.filter(t=>t.done).length;
      document.getElementById('stats').textContent = `${done} completed ‚Ä¢ ${total-done} active ‚Ä¢ ${total} total`;
    }

    // ------------------ Export / Import ------------------
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      if(tasks.length===0) return alert('No tasks to export');
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='todo-etherx-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const importFile = document.getElementById('importFile');
    document.getElementById('importBtn').addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
      reader.onload = ()=>{
        try{ const data = JSON.parse(reader.result); if(!Array.isArray(data)) throw new Error('Invalid');
          // basic validation and merge
          const incoming = data.map(t=>({ id: t.id||uuid(), text: String(t.text||''), done: !!t.done, timestamp: Number(t.timestamp||Date.now()) }));
          tasks = incoming.concat(tasks).slice(0, MAX_TASKS); save(); render(); alert('Import complete');
        }catch(err){ alert('Import failed: invalid file'); }
      };
      reader.readAsText(f);
      importFile.value = '';
    });

    // ------------------ Confetti ------------------
    function fireConfetti(){
      try{
        confetti.create(document.getElementById('confettiCanvas'), { resize:true })({ particleCount: 60, spread: 120 });
      }catch(e){}
    }

    // ------------------ Theme & Controls ------------------
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      document.body.classList.toggle('light'); localStorage.setItem('todoTheme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    document.getElementById('homeBtn').addEventListener('click', ()=>{ location.href='home.html' });

    document.getElementById('addTask').addEventListener('click', ()=>{ addTask(document.getElementById('newTask').value); document.getElementById('newTask').value=''; });
    document.getElementById('newTask').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addTask(e.target.value); e.target.value=''; } });

    document.querySelectorAll('.filter').forEach(b=> b.addEventListener('click', ()=> setFilter(b.dataset.filter)));
    document.getElementById('clearCompleted').addEventListener('click', clearCompleted);

    // Initial render
    render();

    // Accessibility: prevent accidental form zoom/refresh
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&['+','-','=','r','R'].includes(e.key)) e.preventDefault(); });
    document.addEventListener('wheel', (e)=>{ if(e.ctrlKey) e.preventDefault(); }, { passive:false });

  </script></body>
</html>
